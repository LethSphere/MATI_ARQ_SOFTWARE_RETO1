services:
  # Usamos Nginx: Es agnóstico a la versión de Docker y súper ligero
  # proxy:
  #   image: nginx:alpine
  #   container_name: nginx-balancer
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro

  # apihandler:
  #   build:
  #     context: .                # Sube a la raíz para ver common-lib y apihandler
  #     dockerfile: apihandler/Dockerfile
  #   image: apihandler-reto1:v1
  #   environment:
  #     - JAVA_OPTS=-Xmx512m -Xms256m

  # rabbitmq:
  #   image: rabbitmq:3-management
  #   container_name: rabbitmq-broker
  #   ports:
  #     - "5672:5672"    # Comunicación de datos (AMQP)
  #     - "15672:15672"  # Dashboard administrativo
  #   environment:
  #     - RABBITMQ_DEFAULT_USER=guest
  #     - RABBITMQ_DEFAULT_PASS=guest

  # db-journal:
  #   image: postgres:alpine
  #   container_name: postgres-journal
  #   environment:
  #     POSTGRES_DB: trading_db
  #     POSTGRES_USER: admin
  #     POSTGRES_PASSWORD: password
  #   volumes:
  #     - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  # Sustituimos db-journal
  # db-journal:
  #   image: mongo:latest
  #   container_name: mongodb-journal
  #   ports:
  #     - "27017:27017"
  #   environment:
  #     - MONGO_INITDB_DATABASE=trading_db

  # journaler:
  #   build:
  #     context: .                
  #     dockerfile: journaler/Dockerfile
  #   image: journaler-reto1:v1
  #   depends_on:
  #     - rabbitmq
  #     - db-journal
  #   environment:
  #     - SPRING_RABBITMQ_HOST=rabbitmq
  #     - SPRING_DATA_MONGODB_URI=mongodb://db-journal:27017/trading_db
  #     #- SPRING_DATASOURCE_URL=jdbc:postgresql://db-journal:5432/trading_db

  notificaciones:
    build: ./notificaciones-go
    container_name: notificador_mati
    ports:
      - "50051:50051"
    deploy:
      resources:
        limits:
          cpus: '0.5'    # <-- Aquí es donde experimentas (Sube a 1.0, 2.0, etc.)
          memory: 128M
    networks:
      - bolsa-net

  # apihandler-java:
  #   build: ./apihandler-java
  #   container_name: apihandler-java
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - GRPC_NOTIFICADOR_HOST=notificaciones
  #     - GRPC_NOTIFICADOR_PORT=50051
  #   networks:
  #     - bolsa-net
  #   depends_on:
  #     - notificaciones  # Para que Go suba primero

  matching-engine:
    build:
      context: ./event-coordinator/matching-engine
      dockerfile: Dockerfile
    container_name: matching-engine
    ports:
      - "8081:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/matching_engine_db
      - SPRING_DATASOURCE_USERNAME=myuser
      - SPRING_DATASOURCE_PASSWORD=secret
      - 'grpc.client.notificaciones.address=static://notificaciones:50051'
      - 'grpc.client.notificaciones.negotiationType=PLAINTEXT'
    networks:
      - bolsa-net
    depends_on:
      - notificaciones 
      - postgres

  postgres:
    image: 'postgres:latest'
    restart: unless-stopped
    environment:
      - 'POSTGRES_DB=matching_engine_db'
      - 'POSTGRES_PASSWORD=secret'
      - 'POSTGRES_USER=myuser'
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/data/postgres
    networks:
      - bolsa-net

networks:
  bolsa-net:
    driver: bridge

volumes:
  pgdata:
